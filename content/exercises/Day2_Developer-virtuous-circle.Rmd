# Kickstarting an R package

```{r echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

::: {.callout-note icon='true'}

## Aims 

- Kickstart an R package 
- Write and document functions
- Check package 

:::

::: {.callout-tip icon='true'}

**At any time, if you are lost or do not understand how functions in the**
**proposed solution work, type `?<function>` in the R console **
**and a help menu will appear.** 

You can also check the help tab in the corresponding quadrant. 

:::

## Proposed package functionalities {#package-functions}

In this section, we are going to create a package which aims at: 

1. Importing `.bigwig` coverage track files as well as `.bed` files of genomic coordinates
2. Filtering imported `GRanges` to make sure they all are contained within the coverage tracks 
3. Calculating the average (+/- quantiles) of coverage of the `.bigwig` file over the `GRanges` of interest
4. Plot the aggregated `.bigwig` coverage over the `GRanges` of interest 

Eventually, the functions shipped in this package should be able to turn a pair of `.bigwig`/`.bed` files into this type of plot:

...

## Starting a new package

To start developing a new package, one may want to make sure all useful 
developer resources are already set-up. 

::: {.callout-question .icon .callout-note}

Make sure to install the developer toolkit packages.

::: {.callout-answer .icon .callout-note collapse=true}

```{r}
install.packages("remotes")
remotes::install_cran(
    c(
        "available",
        "devtools",
        "rcmdcheck", 
        "knitr",
        "pkgdown",
        "RefManageR",
        "rmarkdown",
        "rstudioapi",
        "sessioninfo",
        "styler",
        "usethis",
        "gert"
    )
)
remotes::install_cran("BiocManager")
BiocManager::install(c("BiocStyle", "BiocCheck", "biocthis"))
```

:::

:::

Now the time has come to create your very first package! 
To keep a coherent cohorte, we'll create a package named `<YOURNAME>TestPackage`. 
But first, you need to make sure that this package name is available. 

::: {.callout-question .icon .callout-note}

Verify that your package name is available, with the `available` package.

::: {.callout-answer .icon .callout-note collapse=true}

```{r}
available::available("JacquesTestPackage")
```

:::

:::

If this name is available, let's create your package. 

::: {.callout-question .icon .callout-note}

Which function from `devtools` can be used to create a package skeleton? 
Use it to create your package. 

::: {.callout-answer .icon .callout-note collapse=true}

```{r}
library(devtools)
create_package("JacquesTestPackage")
```

:::

:::

When creating your package, `devtools`+`RStudio` combo automatically opens a new `RStudio` window, with the package's project automatically activated. Navigate to your package RStudio project window and re-open this instruction sheet. 

::: {.callout-question .icon .callout-note}

Make sure you're in the right project using the appropriate function from `rstudioapi` package.

::: {.callout-answer .icon .callout-note collapse=true}

```{r}
rstudioapi::getActiveProject()
```

:::

:::

::: {.callout-question .icon .callout-note}

Explore the newly created folder architecture. Do you recognize all the files and directories? 

:::


The DESCRIPTION file automatically created does not exactly match Bioconductor 
requirements. You should replace it by a better-fitted DESCRIPTION file. 

::: {.callout-question .icon .callout-note}

Find the appropriate function from `biocthis` to replace the current 
DESCRIPTION file by one fitting BIOCONDUCTOR's requirements. 

::: {.callout-answer .icon .callout-note collapse=true}

```{r}
biocthis::use_bioc_description()
```

:::

:::

::: {.callout-question .icon .callout-note}

Manually edit the important fields from your new DESCRIPTION file: `Title` & `Author`. The remaining fields will be filled out later on. 

:::

::: {.callout-question .icon .callout-note}

Now add a LICENSE file to specify under which license you wish to publish your package. 

::: {.callout-answer .icon .callout-note collapse=true}

```{r}
usethis::use_mit_license()
```

:::

:::

A nice touch is to systematically provide a `README` file. 
This provides a good overview of your package when browsed e.g. in 
GitHub, and for non-R specialists, who don't necessarily know about 
`DESCRIPTION` and vignettes. And since you are developing an R package, 
let's stick with the Rmd format for your `README`.


::: {.callout-question .icon .callout-note}

What are the benefits of having a `README.Rmd` file? 

Which function from `biocthis` can create a `.Rmd` README file? 

::: {.callout-answer .icon .callout-note collapse=true}

```{r}
biocthis::use_bioc_readme_rmd()
```

:::

:::

That being said, package submission requires that a `REAMDE.md` file only 
is present in the repository. A way to provide this is to 1) 
`devtools::build_readme()` to parse `README.Rmd` into `README.md` 
(with R chunks processed!), and 2) add `README.Rmd` to .gitignore. 

::: {.callout-question .icon .callout-note}

Parse your `README.Rmd` into `README.md` and check the differences. 

::: {.callout-answer .icon .callout-note collapse=true}

```{r}
devtools::load_all('.')
devtools::build_readme()
rstudioapi::documentOpen("README.Rmd")
rstudioapi::documentOpen("README.md")
```

:::

:::

A bunch of extra useful commands from `bioc/usethis` can be performed at 
this stage, e.g. to add a NEWS file, a Code of Conduct, a citation file, etc... 
Beware, each command creates/modify one/several files. Pay attention to 
the comments printed in the R console!

::: {.callout-question .icon .callout-note}

Run each of the following commands one by one and make sure to fulfill each required action highlighted in the R console. 

::: {.callout-answer .icon .callout-note collapse=true}

```{r}
biocthis::use_bioc_news_md()  ## To add a NEWS.md file
biocthis::use_bioc_coc()  ## To add a .github/CODE_OF_CONDUCT.md file
biocthis::use_bioc_support()  ## To add a .github/SUPPORT.md file
biocthis::use_bioc_issue_template()  ## To add a .github/ISSUE_TEMPLATE/issue_template.md file
biocthis::use_bioc_citation()  ## To add a inst/CITATION file
usethis::use_lifecycle_badge("Experimental")  ## To add a "Experimental" badge to your README.Rmd
devtools::build_readme()  ## To rebuild README.md
```

:::

:::

## Write functions to populate your package

To write your first package function, you can either create an `R/<name>.R` 
file manually, or run `usethis::use_r(name)`.

Now is time to write! Refer to the functionalities (descriped in 
[Section 0](#package-functions)) that we are aiming to provide in this package, 
and start writing 4 functions which, together, can fulfill these 
functionalities. Briefly, we suggest to design functions to: 

1. `import` a coverage track and a set of genomic features (scaled to a fixed width) together in a list;
2. `filter` the imported features to only retain those fully overlapping with covered genome segments (from the coverage track);
3. `compute` the mean coverage and its confidence interval, for each position within the features' width;
4. `plot` the results with `ggplot2`.

::: {.callout-tip icon='true'}

These functions should work in a chain: 

```{r}
import(bw_path, features_path, width) |>
    filter() |> 
    compute() |> 
    plot()
```

:::

::: {.callout-tip icon='true'}

The content of the proposed function files is shown 
in `Share/Day2/functions/`. These files provides an 
example of implementation to fulfill our package's requirements. 

:::

## Add function documentation

::: {.callout-question .icon .callout-note}

Write oxygen tags (`title`, `description`, `@param`, `@return`, ...) for each 
function. 

:::

Once you have documented each function, you can regenerate the documentation with 
`document()`.

```{r}
document()
```

## Check your package

Several `check` functions are available. They each check your package in a 
specific way. 

- `devtools::check()` verifies the basic structure of the package, the documentation, the examples and unit tests; 
- `rcmdcheck::rcmdcheck()` does somewhat the same job but builds the package first;
- `BiocCheck::BiocCheck()` checks the compliance of the package with `Bioconductor` requirements. 

```{r}
check()
rcmdcheck::rcmdcheck()
BiocCheck()
```

::: {.callout-question .icon .callout-note}

Attempt to fix the `ERROR` and `WARNING` returned by `check()` and `BiocCheck()`. 

:::
